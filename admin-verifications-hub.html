<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Verifications 管理后台</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* —— 样式（同上版） —— */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;display:flex;flex-direction:column;align-items:center}
    h1{font-size:22px;margin-bottom:10px}
    .btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer}
    .btn:hover{background:#555}
    table{width:100%;max-width:900px;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{padding:12px;border:1px solid #ddd;text-align:left}
    th{background:#eee}
    #searchInput{padding:8px;width:250px}
    .pagination{margin-top:20px}.pagination button{margin-right:5px;padding:6px 10px}
    .hidden{display:none}
    @media(max-width:768px){
      body{display:block;padding:10px}
      h1{font-size:18px;margin-bottom:10px}
      #searchInput,#logoutBtn,.btn{width:100%;margin-bottom:10px;padding:12px;font-size:16px}
      .pagination{display:flex;flex-wrap:wrap;justify-content:center;width:100%;margin-top:20px}
      .pagination button{flex:1 1 30%;margin:5px;padding:10px}
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{margin-bottom:15px;border:1px solid #ccc;background:#fff;padding:10px}
      tbody td{display:flex;justify-content:space-between;padding:8px;border:none;border-bottom:1px solid #eee}
      tbody td::before{content:attr(data-label);font-weight:bold;color:#555;margin-right:10px;flex-shrink:0}
    }
  </style>
</head>
<body>
  <h1>Verifications 管理后台</h1>

  <div id="authArea">
    <button id="loginBtn" class="btn">登录查看 verifications</button>
  </div>

  <div id="adminArea" class="hidden">
    <span id="adminEmail"></span>
    <button id="logoutBtn" class="btn">退出登录</button>

    <div style="margin-top:20px">
      <input type="text" id="searchInput" placeholder="搜索邮箱 / Code / 留言内容">
      <button id="searchBtn" class="btn">搜索</button>
    </div>

    <table id="veriTable">
      <thead>
        <tr><th>ID</th><th>邮箱</th><th>Code</th><th>失效</th><th>已验证</th><th>留言</th><th>创建</th><th>操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script>
  /* ===== 配置 ===== */
  const SUPABASE_URL='https://wrgfrjwwtxyonbqxxnvp.supabase.co';
  const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3Mi...dfPg';
  const ADMIN_EMAIL='oliveroogle@gmail.com';
  const REDIRECT_URL='https://mefans.pages.dev/admin-verifications-hub.html';

  const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

  /* ===== DOM ===== */
  const $=id=>document.getElementById(id);
  const loginBtn=$('loginBtn'),logoutBtn=$('logoutBtn');
  const authArea=$('authArea'),adminArea=$('adminArea');
  const adminEmail=$('adminEmail');
  const searchInput=$('searchInput'),searchBtn=$('searchBtn');
  const tbody=$('veriTable').querySelector('tbody');
  const pagination=$('pagination');

  let currentPage=1,limit=8;

  /* ===== 登录 / 退出 ===== */
  loginBtn.onclick=()=>client.auth.signInWithOAuth({provider:'github',options:{redirectTo:REDIRECT_URL}});
  logoutBtn.onclick=async()=>{await client.auth.signOut();location.reload();};

  /* ===== 加载数据 ===== */
  async function load(page=1,kw=''){
    const from=(page-1)*limit,to=from+limit-1;
    let q=client.from('verifications')
               .select('*',{count:'exact'})
               .order('created_at',{ascending:false})
               .range(from,to);
    if(kw) q=q.or(`email.ilike.%${kw}%,code.ilike.%${kw}%,content.ilike.%${kw}%`);
    const {data,error,count}=await q;
    if(error) return alert('加载失败：'+error.message);

    tbody.innerHTML=data.map(r=>`
      <tr>
        <td data-label="ID">${r.id}</td>
        <td data-label="邮箱">${r.email}</td>
        <td data-label="Code">${r.code}</td>
        <td data-label="失效">${new Date(r.expires_at).toLocaleString()}</td>
        <td data-label="已验证">${r.verified}</td>
        <td data-label="留言">${r.content||''}</td>
        <td data-label="创建">${new Date(r.created_at).toLocaleString()}</td>
        <td data-label="操作"><button class="btn" style="background:#a00" onclick="del(${r.id})">删</button></td>
      </tr>`).join('');
    renderPagination(count||0,page);
  }
  async function del(id){
    if(!confirm('确认删除？'))return;
    const {error}=await client.from('verifications').delete().eq('id',id);
    if(error) alert('删除失败：'+error.message);
    else load(currentPage,searchInput.value.trim());
  }

  function renderPagination(total,active){
    pagination.innerHTML='';
    const pages=Math.ceil(total/limit);
    for(let i=1;i<=pages;i++){
      const b=document.createElement('button'); b.textContent=i;b.className='btn';
      if(i===active) b.style.background='#888';
      b.onclick=()=>{currentPage=i;load(i,searchInput.value.trim());};
      pagination.appendChild(b);
    }
  }

  /* —— 搜索 —— */
  searchBtn.onclick=()=>{currentPage=1;load(1,searchInput.value.trim());};

  /* ★ 自动复位：搜索框清空时重载全部 */
  searchInput.addEventListener('input',()=>{              /* ★ */
    if(!searchInput.value.trim()){                        /* ★ */
      currentPage=1; load(1,'');                          /* ★ */
    }                                                     /* ★ */
  });                                                     /* ★ */

  /* ===== 鉴权 ===== */
  (async()=>{
    try{await client.auth.getSessionFromUrl({storeSession:true});}catch{}
    if(location.hash||location.search.includes('code=')){history.replaceState(null,'',location.pathname.replace(/\.html$/,''));}

    const {data:{session}}=await client.auth.getSession();
    if(session?.user?.email===ADMIN_EMAIL){
      authArea.classList.add('hidden');adminArea.classList.remove('hidden');
      adminEmail.textContent='当前账号：'+session.user.email;
      load();
    }
  })();
  </script>
</body>
</html>
