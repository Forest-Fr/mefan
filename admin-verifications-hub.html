<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Verifications 管理后台</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* —— 样式同前，略 —— */
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;margin:0;display:flex;flex-direction:column;align-items:center}
    h1{font-size:22px;margin-bottom:10px}
    .btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer}
    .btn:hover{background:#555}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>Verifications 管理后台</h1>
  <!-- 未登录 -->
  <div id="auth"><button id="login" class="btn">登录查看 verifications</button></div>
  <!-- 已登录 -->
  <div id="admin" class="hidden">
    <span id="mail"></span><button id="logout" class="btn" style="margin-left:1rem">退出登录</button>
    <table style="margin-top:20px;width:100%;max-width:900px;background:#fff;border-collapse:collapse">
      <thead><tr><th>ID</th><th>邮箱</th><th>Code</th><th>失效</th><th>已验证</th><th>留言</th><th>创建</th><th>操作</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script>
  /* ===== 常量 ===== */
  const SUPABASE_URL = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
  const ADMIN_EMAIL  = 'oliveroogle@gmail.com';
  const REDIRECT_URL = 'https://mefans.pages.dev/admin-verifications-hub.html';  // 固定为 .html

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  /* ===== DOM ===== */
  const $ = id => document.getElementById(id);
  const auth   = $('auth');
  const admin  = $('admin');
  const login  = $('login');
  const logout = $('logout');
  const mailEl = $('mail');
  const tbody  = $('tbody');

  /* ===== 登录 ===== */
  login.onclick = async () => {
    const { error } = await client.auth.signInWithOAuth({
      provider:'github',
      options:{ redirectTo: REDIRECT_URL }
    });
    if (error) console.error('OAuth 启动失败：', error);
  };
  logout.onclick = async () => { await client.auth.signOut(); location.reload(); };

  /* ===== 加载数据 ===== */
  async function load(){
    const { data, error } = await client
      .from('verifications')
      .select('*')
      .order('created_at',{ascending:false})
      .limit(30);
    if(error) return alert('加载失败：'+error.message);

    tbody.innerHTML = data.map(r=>`
      <tr>
        <td>${r.id}</td><td>${r.email}</td><td>${r.code}</td>
        <td>${new Date(r.expires_at).toLocaleString()}</td>
        <td>${r.verified}</td><td>${r.content||''}</td>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td><button class="btn" style="background:#a00" onclick="del(${r.id})">删</button></td>
      </tr>
    `).join('');
  }
  async function del(id){
    if(!confirm('确认删除？'))return;
    const { error } = await client.from('verifications').delete().eq('id',id);
    if(error) alert('删除失败：'+error.message);
    else load();
  }

  /* ===== 回调解析 & 权限判断 ===== */
  (async () => {
    try { await client.auth.getSessionFromUrl({ storeSession:true }); }
    catch(e) { /* 不是回调时会抛 404，可忽略 */ }

    /* 打印看看拿到什么 session */
    let { data:{ session } } = await client.auth.getSession();
    console.log('Supabase session =', session);

    if (session?.user?.email === ADMIN_EMAIL){
      auth.classList.add('hidden'); admin.classList.remove('hidden');
      mailEl.textContent = '当前账号：' + session.user.email;
      load();
    }

    /* 清 hash / code，洗掉 .html（用户视角更干净） */
    if (location.hash || location.search.includes('code=')) {
      history.replaceState(null,'',location.pathname.replace(/\.html$/,''));
    }
  })();
  </script>
</body>
</html>
