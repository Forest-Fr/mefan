<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>🔧 Verifications 管理后台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* —— 样式与之前保持一致 —— */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial, sans-serif;background:#f0f2f5;color:#333;display:flex;justify-content:center;padding:1rem}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:1.5rem;margin-bottom:1.5rem}
    h1{text-align:center;margin-bottom:1rem}
    .hidden{display:none}
    .btn{display:inline-block;padding:.5rem 1rem;margin:.5rem 0;background:#0058a3;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:background .2s}
    .btn:hover{background:#004080}
    #adminInfo{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .search-bar{display:flex;gap:.5rem;margin-bottom:1rem}
    .search-bar input{flex:1;padding:.5rem;border:1px solid #ccc;border-radius:4px}
    .pagination{text-align:center;margin-top:1rem}
    .pagination .btn{margin:0 .25rem;padding:.4rem .8rem;background:#e0e0e0;color:#333}
    .pagination .btn.active{background:#0058a3;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.6rem;border:1px solid #ddd;text-align:left}
    th{background:#fafafa}
    td.actions{text-align:center}
    td.actions .btn{background:#a00;padding:.3rem .6rem}
    @media(max-width:768px){
      .search-bar{flex-direction:column}
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid #ccc;border-radius:4px;margin-bottom:.75rem;padding:.5rem;background:#fff}
      tbody td{display:flex;justify-content:space-between;padding:.5rem;border:none;border-bottom:1px solid #eee}
      tbody td::before{content:attr(data-label);font-weight:bold}
      td.actions{justify-content:center}
    }
  </style>
  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>🔧 Verifications 管理后台</h1>

    <!-- 未登录 -->
    <div id="authArea">
      <button id="btn-login" class="btn">使用 GitHub 登录</button>
    </div>

    <!-- 无权限 -->
    <div id="noPermArea" class="hidden">
      <p>❌ 当前账户无管理员权限。</p>
      <button id="btn-logout1" class="btn">退出登录</button>
    </div>

    <!-- 后台 -->
    <div id="adminArea" class="hidden">
      <div id="adminInfo">
        <span id="adminEmail">当前账号：</span>
        <button id="btn-logout2" class="btn">退出登录</button>
      </div>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜索 email / code / content">
        <button id="searchBtn" class="btn">搜索</button>
      </div>

      <table>
        <thead>
          <tr><th>ID</th><th>邮箱</th><th>Code</th><th>失效时间</th><th>已验证</th><th>留言内容</th><th>创建时间</th><th>操作</th></tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>

      <div class="pagination" id="pagination"></div>
    </div>
  </div>

<script>
/* ===== 配置 ===== */
const SUPABASE_URL   = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co';
const SUPABASE_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
const ADMIN_EMAIL    = 'oliveroogle@gmail.com';
const ITEMS_PER_PAGE = 8;
const CURRENT_URL    = location.origin + location.pathname;  // https://mefans.pages.dev/admin-verifications-hub.html

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== DOM ===== */
const authArea   = document.getElementById('authArea');
const noPermArea = document.getElementById('noPermArea');
const adminArea  = document.getElementById('adminArea');
const btnLogin   = document.getElementById('btn-login');
const btnLogout1 = document.getElementById('btn-logout1');
const btnLogout2 = document.getElementById('btn-logout2');
const adminEmail = document.getElementById('adminEmail');
const searchInput= document.getElementById('searchInput');
const searchBtn  = document.getElementById('searchBtn');
const dataBody   = document.getElementById('dataBody');
const pagination = document.getElementById('pagination');

let currentPage = 1;

/* ===== 解析回调 ===== */
(async () => {
  try {               // 兼容 #access_token 和 ?code 两种方式
    await client.auth.getSessionFromUrl({ storeSession:true });
  } catch(e) { /* ignore if not a callback */ }

  // 去掉 URL hash / query 中的 token
  if (location.hash || location.search.includes('code=')) {
    history.replaceState(null,'',CURRENT_URL);
  }
  checkAuth();
})();

/* ===== 监听状态变化 ===== */
client.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && location.href !== CURRENT_URL) {
    location.replace(CURRENT_URL);          // 兜底：强制回到后台页
  }
  checkAuth(session);
});

/* ===== 权限判断 ===== */
async function checkAuth(session){
  if(!session){
    ({ data:{ session } } = await client.auth.getSession());
  }
  if(session?.user?.email === ADMIN_EMAIL){
    showAdmin(session.user.email);
  }else if(session?.user){
    showNoPerm();
  }else{
    showAuth();
  }
}
/* ===== UI 切换 ===== */
function showAuth (){authArea.classList.remove('hidden');noPermArea.classList.add('hidden');adminArea.classList.add('hidden');}
function showNoPerm(){authArea.classList.add('hidden');noPermArea.classList.remove('hidden');adminArea.classList.add('hidden');}
function showAdmin(email){
  authArea.classList.add('hidden');noPermArea.classList.add('hidden');adminArea.classList.remove('hidden');
  adminEmail.textContent = '当前管理员：' + email;
  loadData(1);
}

/* ===== 登录 / 退出 ===== */
btnLogin .onclick = () => client.auth.signInWithOAuth({
  provider:'github',
  options:{ redirectTo: CURRENT_URL }        // ✅ 正确传对象
});
[btnLogout1,btnLogout2].forEach(btn => btn.onclick = async () => {
  await client.auth.signOut();
  showAuth();
});

/* ===== 数据加载 ===== */
async function loadData(page, keyword=''){
  currentPage = page;
  const from = (page-1)*ITEMS_PER_PAGE;
  const to   = from+ITEMS_PER_PAGE-1;

  let query = client.from('verifications')
                   .select('*',{ count:'exact' })
                   .order('created_at',{ ascending:false })
                   .range(from,to);

  if(keyword){
    query = query.or(`email.ilike.%${keyword}%,code.ilike.%${keyword}%,content.ilike.%${keyword}%`);
  }

  const { data,error,count } = await query;
  if(error){
    dataBody.innerHTML = `<tr><td colspan="8" style="color:red">加载失败：${error.message}</td></tr>`;
    return;
  }
  if(!data?.length){
    dataBody.innerHTML = '<tr><td colspan="8">暂无数据</td></tr>';
  }else{
    dataBody.innerHTML = data.map(r=>`
      <tr>
        <td data-label="ID">${r.id}</td>
        <td data-label="邮箱">${r.email}</td>
        <td data-label="Code">${r.code}</td>
        <td data-label="失效时间">${new Date(r.expires_at).toLocaleString()}</td>
        <td data-label="已验证">${r.verified}</td>
        <td data-label="留言内容">${r.content||''}</td>
        <td data-label="创建时间">${new Date(r.created_at).toLocaleString()}</td>
        <td data-label="操作" class="actions">
          <button class="btn" onclick="deleteRow(${r.id})">删除</button>
        </td>
      </tr>`).join('');
  }
  renderPagination(count||0);
}
async function deleteRow(id){
  if(!confirm('确认删除 ID='+id+' 的记录？')) return;
  const { error } = await client.from('verifications').delete().eq('id',id);
  if(error) alert('删除失败：'+error.message);
  else      loadData(currentPage,searchInput.value.trim());
}
function renderPagination(total){
  const pages = Math.ceil(total/ITEMS_PER_PAGE);
  pagination.innerHTML='';
  for(let i=1;i<=pages;i++){
    const btn=document.createElement('button');
    btn.textContent=i;
    btn.className='btn'+(i===currentPage?' active':'');
    btn.onclick = () => loadData(i,searchInput.value.trim());
    pagination.appendChild(btn);
  }
}
searchBtn.onclick = () => loadData(1,searchInput.value.trim());
</script>
</body>
</html>
