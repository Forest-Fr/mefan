<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”§ Verifications ç®¡ç†åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* â€”â€” æ ·å¼ä¸ä¹‹å‰ä¿æŒä¸€è‡´ â€”â€” */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial, sans-serif;background:#f0f2f5;color:#333;display:flex;justify-content:center;padding:1rem}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:1.5rem;margin-bottom:1.5rem}
    h1{text-align:center;margin-bottom:1rem}
    .hidden{display:none}
    .btn{display:inline-block;padding:.5rem 1rem;margin:.5rem 0;background:#0058a3;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:background .2s}
    .btn:hover{background:#004080}
    #adminInfo{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .search-bar{display:flex;gap:.5rem;margin-bottom:1rem}
    .search-bar input{flex:1;padding:.5rem;border:1px solid #ccc;border-radius:4px}
    .pagination{text-align:center;margin-top:1rem}
    .pagination .btn{margin:0 .25rem;padding:.4rem .8rem;background:#e0e0e0;color:#333}
    .pagination .btn.active{background:#0058a3;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.6rem;border:1px solid #ddd;text-align:left}
    th{background:#fafafa}
    td.actions{text-align:center}
    td.actions .btn{background:#a00;padding:.3rem .6rem}
    @media(max-width:768px){
      .search-bar{flex-direction:column}
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid #ccc;border-radius:4px;margin-bottom:.75rem;padding:.5rem;background:#fff}
      tbody td{display:flex;justify-content:space-between;padding:.5rem;border:none;border-bottom:1px solid #eee}
      tbody td::before{content:attr(data-label);font-weight:bold}
      td.actions{justify-content:center}
    }
  </style>
  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Verifications ç®¡ç†åå°</h1>

    <!-- æœªç™»å½• -->
    <div id="authArea">
      <button id="btn-login" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
    </div>

    <!-- æ— æƒé™ -->
    <div id="noPermArea" class="hidden">
      <p>âŒ å½“å‰è´¦æˆ·æ— ç®¡ç†å‘˜æƒé™ã€‚</p>
      <button id="btn-logout1" class="btn">é€€å‡ºç™»å½•</button>
    </div>

    <!-- åå° -->
    <div id="adminArea" class="hidden">
      <div id="adminInfo">
        <span id="adminEmail">å½“å‰è´¦å·ï¼š</span>
        <button id="btn-logout2" class="btn">é€€å‡ºç™»å½•</button>
      </div>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢ email / code / content">
        <button id="searchBtn" class="btn">æœç´¢</button>
      </div>

      <table>
        <thead>
          <tr><th>ID</th><th>é‚®ç®±</th><th>Code</th><th>å¤±æ•ˆæ—¶é—´</th><th>å·²éªŒè¯</th><th>ç•™è¨€å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>

      <div class="pagination" id="pagination"></div>
    </div>
  </div>

<script>
/* ===== é…ç½® ===== */
const SUPABASE_URL   = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co';
const SUPABASE_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
const ADMIN_EMAIL    = 'oliveroogle@gmail.com';
const ITEMS_PER_PAGE = 8;
const CURRENT_URL    = location.origin + location.pathname;  // https://mefans.pages.dev/admin-verifications-hub.html

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== DOM ===== */
const authArea   = document.getElementById('authArea');
const noPermArea = document.getElementById('noPermArea');
const adminArea  = document.getElementById('adminArea');
const btnLogin   = document.getElementById('btn-login');
const btnLogout1 = document.getElementById('btn-logout1');
const btnLogout2 = document.getElementById('btn-logout2');
const adminEmail = document.getElementById('adminEmail');
const searchInput= document.getElementById('searchInput');
const searchBtn  = document.getElementById('searchBtn');
const dataBody   = document.getElementById('dataBody');
const pagination = document.getElementById('pagination');

let currentPage = 1;

/* ===== è§£æå›è°ƒ ===== */
(async () => {
  try {               // å…¼å®¹ #access_token å’Œ ?code ä¸¤ç§æ–¹å¼
    await client.auth.getSessionFromUrl({ storeSession:true });
  } catch(e) { /* ignore if not a callback */ }

  // å»æ‰ URL hash / query ä¸­çš„ token
  if (location.hash || location.search.includes('code=')) {
    history.replaceState(null,'',CURRENT_URL);
  }
  checkAuth();
})();

/* ===== ç›‘å¬çŠ¶æ€å˜åŒ– ===== */
client.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && location.href !== CURRENT_URL) {
    location.replace(CURRENT_URL);          // å…œåº•ï¼šå¼ºåˆ¶å›åˆ°åå°é¡µ
  }
  checkAuth(session);
});

/* ===== æƒé™åˆ¤æ–­ ===== */
async function checkAuth(session){
  if(!session){
    ({ data:{ session } } = await client.auth.getSession());
  }
  if(session?.user?.email === ADMIN_EMAIL){
    showAdmin(session.user.email);
  }else if(session?.user){
    showNoPerm();
  }else{
    showAuth();
  }
}
/* ===== UI åˆ‡æ¢ ===== */
function showAuth (){authArea.classList.remove('hidden');noPermArea.classList.add('hidden');adminArea.classList.add('hidden');}
function showNoPerm(){authArea.classList.add('hidden');noPermArea.classList.remove('hidden');adminArea.classList.add('hidden');}
function showAdmin(email){
  authArea.classList.add('hidden');noPermArea.classList.add('hidden');adminArea.classList.remove('hidden');
  adminEmail.textContent = 'å½“å‰ç®¡ç†å‘˜ï¼š' + email;
  loadData(1);
}

/* ===== ç™»å½• / é€€å‡º ===== */
btnLogin .onclick = () => client.auth.signInWithOAuth({
  provider:'github',
  options:{ redirectTo: CURRENT_URL }        // âœ… æ­£ç¡®ä¼ å¯¹è±¡
});
[btnLogout1,btnLogout2].forEach(btn => btn.onclick = async () => {
  await client.auth.signOut();
  showAuth();
});

/* ===== æ•°æ®åŠ è½½ ===== */
async function loadData(page, keyword=''){
  currentPage = page;
  const from = (page-1)*ITEMS_PER_PAGE;
  const to   = from+ITEMS_PER_PAGE-1;

  let query = client.from('verifications')
                   .select('*',{ count:'exact' })
                   .order('created_at',{ ascending:false })
                   .range(from,to);

  if(keyword){
    query = query.or(`email.ilike.%${keyword}%,code.ilike.%${keyword}%,content.ilike.%${keyword}%`);
  }

  const { data,error,count } = await query;
  if(error){
    dataBody.innerHTML = `<tr><td colspan="8" style="color:red">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
    return;
  }
  if(!data?.length){
    dataBody.innerHTML = '<tr><td colspan="8">æš‚æ— æ•°æ®</td></tr>';
  }else{
    dataBody.innerHTML = data.map(r=>`
      <tr>
        <td data-label="ID">${r.id}</td>
        <td data-label="é‚®ç®±">${r.email}</td>
        <td data-label="Code">${r.code}</td>
        <td data-label="å¤±æ•ˆæ—¶é—´">${new Date(r.expires_at).toLocaleString()}</td>
        <td data-label="å·²éªŒè¯">${r.verified}</td>
        <td data-label="ç•™è¨€å†…å®¹">${r.content||''}</td>
        <td data-label="åˆ›å»ºæ—¶é—´">${new Date(r.created_at).toLocaleString()}</td>
        <td data-label="æ“ä½œ" class="actions">
          <button class="btn" onclick="deleteRow(${r.id})">åˆ é™¤</button>
        </td>
      </tr>`).join('');
  }
  renderPagination(count||0);
}
async function deleteRow(id){
  if(!confirm('ç¡®è®¤åˆ é™¤ ID='+id+' çš„è®°å½•ï¼Ÿ')) return;
  const { error } = await client.from('verifications').delete().eq('id',id);
  if(error) alert('åˆ é™¤å¤±è´¥ï¼š'+error.message);
  else      loadData(currentPage,searchInput.value.trim());
}
function renderPagination(total){
  const pages = Math.ceil(total/ITEMS_PER_PAGE);
  pagination.innerHTML='';
  for(let i=1;i<=pages;i++){
    const btn=document.createElement('button');
    btn.textContent=i;
    btn.className='btn'+(i===currentPage?' active':'');
    btn.onclick = () => loadData(i,searchInput.value.trim());
    pagination.appendChild(btn);
  }
}
searchBtn.onclick = () => loadData(1,searchInput.value.trim());
</script>
</body>
</html>
