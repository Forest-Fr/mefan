<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”§ Verifications ç®¡ç†åå°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* â€”â€” å…¨å±€ â€”â€” */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#f0f2f5;color:#333;display:flex;justify-content:center;padding:1rem}
    .container{width:100%;max-width:1000px;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:1.5rem;margin-bottom:1.5rem}
    h1{text-align:center;margin-bottom:1rem}
    .hidden{display:none}
    /* â€”â€” æŒ‰é’® â€”â€” */
    .btn{display:inline-block;padding:.5rem 1rem;margin:.5rem 0;background:#0058a3;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:background .2s}
    .btn:hover{background:#004080}
    /* â€”â€” åŒºå— â€”â€” */
    #authArea,#noPermArea,#adminArea{text-align:center}
    #adminInfo{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    /* â€”â€” æœç´¢+åˆ†é¡µ â€”â€” */
    .search-bar{display:flex;gap:.5rem;margin-bottom:1rem}
    .search-bar input{flex:1;padding:.5rem;border:1px solid #ccc;border-radius:4px}
    .pagination{text-align:center;margin-top:1rem}
    .pagination .btn{margin:0 .25rem;padding:.4rem .8rem;background:#e0e0e0;color:#333}
    .pagination .btn.active{background:#0058a3;color:#fff}
    /* â€”â€” è¡¨æ ¼ â€”â€” */
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.6rem;border:1px solid #ddd;text-align:left}
    th{background:#fafafa}
    td.actions{text-align:center}
    td.actions .btn{background:#a00;padding:.3rem .6rem}
    /* â€”â€” æ‰‹æœºç«¯ â€”â€” */
    @media (max-width:768px){
      .search-bar{flex-direction:column}
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid #ccc;border-radius:4px;margin-bottom:.75rem;padding:.5rem;background:#fff}
      tbody td{display:flex;justify-content:space-between;padding:.5rem;border:none;border-bottom:1px solid #eee}
      tbody td::before{content:attr(data-label);font-weight:bold}
      td.actions{justify-content:center}
    }
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Verifications ç®¡ç†åå°</h1>

    <!-- æœªç™»å½• -->
    <div id="authArea">
      <button id="btn-login" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
    </div>

    <!-- ç™»å½•ä½†æ— æƒé™ -->
    <div id="noPermArea" class="hidden">
      <p>âŒ å½“å‰è´¦æˆ·æ— ç®¡ç†å‘˜æƒé™ã€‚</p>
      <button id="btn-logout1" class="btn">é€€å‡ºç™»å½•</button>
    </div>

    <!-- åå° -->
    <div id="adminArea" class="hidden">
      <div id="adminInfo">
        <span id="adminEmail">å½“å‰è´¦å·ï¼š</span>
        <button id="btn-logout2" class="btn">é€€å‡ºç™»å½•</button>
      </div>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢ email / code / content"/>
        <button id="searchBtn" class="btn">æœç´¢</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th><th>é‚®ç®±</th><th>Code</th><th>å¤±æ•ˆæ—¶é—´</th>
            <th>å·²éªŒè¯</th><th>ç•™è¨€å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>

      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
  /* ===== é…ç½® ===== */
  const SUPABASE_URL      = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
  const ADMIN_EMAIL       = 'oliveroogle@gmail.com';
  const ITEMS_PER_PAGE    = 8;
  const REDIRECT_URL      = 'https://mefans.pages.dev/admin-verifications-hub.html';

  /* ===== åˆå§‹åŒ– ===== */
  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authArea   = document.getElementById('authArea');
  const noPermArea = document.getElementById('noPermArea');
  const adminArea  = document.getElementById('adminArea');
  const btnLogin   = document.getElementById('btn-login');
  const btnLogout1 = document.getElementById('btn-logout1');
  const btnLogout2 = document.getElementById('btn-logout2');
  const adminEmail = document.getElementById('adminEmail');
  const searchInput= document.getElementById('searchInput');
  const searchBtn  = document.getElementById('searchBtn');
  const dataBody   = document.getElementById('dataBody');
  const pagination = document.getElementById('pagination');
  let currentPage  = 1;

  /* ===== å¤„ç† OAuth å›è°ƒ ===== */
  (async () => {
    await client.auth.getSessionFromUrl({ storeSession: true });
    if (location.hash) history.replaceState(null,'',location.pathname+location.search);
    checkAuth();
  })();

  client.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') {
      // â˜… ä¿®å¤ï¼šç¡®ä¿è½åˆ°åå°é¡µ
      if (location.href !== REDIRECT_URL) location.replace(REDIRECT_URL);
    }
    checkAuth(session);
  });

  async function checkAuth(session){
    if (!session){
      const { data } = await client.auth.getSession();
      session = data.session;
    }
    if (session?.user?.email === ADMIN_EMAIL){
      showAdmin(session.user.email);
    } else if (session?.user){
      showNoPerm();
    } else {
      showAuth();
    }
  }

  function showAuth(){ authArea.classList.remove('hidden'); noPermArea.classList.add('hidden'); adminArea.classList.add('hidden'); }
  function showNoPerm(){ authArea.classList.add('hidden'); noPermArea.classList.remove('hidden'); adminArea.classList.add('hidden'); }
  function showAdmin(email){ authArea.classList.add('hidden'); noPermArea.classList.add('hidden'); adminArea.classList.remove('hidden'); adminEmail.textContent='å½“å‰ç®¡ç†å‘˜ï¼š'+email; loadData(1); }

  /* ===== ç™»å½• ===== */
  btnLogin.onclick = async () => {
    try{                                         // â˜… ä¿®å¤ï¼šåŠ  try/catch é¿å…é™é»˜å¤±è´¥
      await client.auth.signInWithOAuth({
        provider:'github',
        options:{ redirectTo: REDIRECT_URL }    // â˜… ä¿®å¤ï¼šoptions å¿…é¡»æ˜¯å¯¹è±¡
      });
    }catch(err){ console.error('ç™»å½•å¤±è´¥:',err); alert('æ— æ³•è·³è½¬ GitHub ç™»å½•ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯'); }
  };

  [btnLogout1,btnLogout2].forEach(btn => btn.onclick = async () => {
    await client.auth.signOut();
    showAuth();
  });

  /* ===== æ•°æ®åŠ è½½ ===== */
  async function loadData(page, keyword=''){
    currentPage = page;
    const from = (page-1)*ITEMS_PER_PAGE, to = from+ITEMS_PER_PAGE-1;

    let query = client.from('verifications')
                      .select('*',{ count:'exact' })
                      .order('created_at',{ ascending:false })
                      .range(from,to);

    if (keyword){
      query = query.or(`email.ilike.%${keyword}%,code.ilike.%${keyword}%,content.ilike.%${keyword}%`);
    }

    const { data, error, count } = await query;
    if (error){ dataBody.innerHTML=`<tr><td colspan="8" style="color:red">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`; return; }

    dataBody.innerHTML = (data.length?data:[{}]).map(r=>data.length?`
      <tr>
        <td data-label="ID">${r.id}</td>
        <td data-label="é‚®ç®±">${r.email}</td>
        <td data-label="Code">${r.code}</td>
        <td data-label="å¤±æ•ˆæ—¶é—´">${new Date(r.expires_at).toLocaleString()}</td>
        <td data-label="å·²éªŒè¯">${r.verified}</td>
        <td data-label="ç•™è¨€å†…å®¹">${r.content||''}</td>
        <td data-label="åˆ›å»ºæ—¶é—´">${new Date(r.created_at).toLocaleString()}</td>
        <td data-label="æ“ä½œ" class="actions"><button class="btn" onclick="deleteRow(${r.id})">åˆ é™¤</button></td>
      </tr>`:`<tr><td colspan="8">æš‚æ— æ•°æ®</td></tr>`).join('');
    renderPagination(count||0);
  }

  async function deleteRow(id){
    if (!confirm('ç¡®è®¤åˆ é™¤ ID='+id+' çš„è®°å½•ï¼Ÿ')) return;
    const { error } = await client.from('verifications').delete().eq('id',id);
    if (error) alert('åˆ é™¤å¤±è´¥ï¼š'+error.message);
    else loadData(currentPage,searchInput.value.trim());
  }

  function renderPagination(total){
    pagination.innerHTML='';
    const pages=Math.ceil(total/ITEMS_PER_PAGE);
    for (let i=1;i<=pages;i++){
      const b=document.createElement('button');
      b.textContent=i; b.className='btn'+(i===currentPage?' active':'');
      b.onclick=()=>loadData(i,searchInput.value.trim());
      pagination.appendChild(b);
    }
  }

  searchBtn.onclick = () => loadData(1,searchInput.value.trim());
  </script>
</body>
</html>
